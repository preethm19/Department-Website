<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>MIT AI SMS - Student Dashboard</title>
  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="32x32" href="../images/logo.png">
  <link rel="icon" type="image/png" sizes="16x16" href="../images/logo.png">
  <link rel="icon" type="image/x-icon" href="../images/logo.png">
  <link rel="shortcut icon" type="image/x-icon" href="../images/logo.png">
  <link rel="apple-touch-icon" sizes="180x180" href="../images/logo.png">
  <link rel="icon" sizes="192x192" href="../images/logo.png">
  <meta name="msapplication-TileImage" content="../images/logo.png">
  <meta name="msapplication-TileColor" content="#4f46e5">
  <link rel="stylesheet" href="../css/style.css">
</head>
<body class="student-panel">
  <!-- Sidebar Overlay for Mobile -->
  <div class="sidebar-overlay" id="sidebarOverlay"></div>

  <!-- Sidebar Toggle Button for Mobile -->
  <button class="sidebar-toggle" onclick="toggleSidebar()">☰</button>

  <!-- Sidebar Navigation -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div class="welcome-section">
        <h3 class="welcome-text">Welcome,</h3>
        <h2 class="user-name" id="userName">Student</h2>
        <p class="user-role" id="userRole">Student</p>
      </div>
    </div>
    <nav class="sidebar-nav">
      <ul>
        <li><a href="dashboard.html"><span class="icon">🏠</span>Dashboard</a></li>
        <li><a href="profile.html"><span class="icon">🙎🏻‍♂️</span>Profile</a></li>
        <li><a href="classes.html"><span class="icon">📚</span>My Classes</a></li>
        <li><a href="assignments.html"><span class="icon">📝</span>Assignments</a></li>
        <li><a href="attendance.html"><span class="icon">📊</span>Attendance</a></li>
        <li><a href="marks.html"><span class="icon">🏆</span>My Marks</a></li>
        <li><a href="notifications.html"><span class="icon">🔔</span>Notifications</a></li>
        <li><a href="documents.html" class="active"><span class="icon">📄</span>Documents</a></li>
      </ul>
    </nav>
    <div class="sidebar-footer">
      <button id="logout" class="btn">Logout</button>
    </div>
  </div>

  <!-- Main Content Area -->
  <div class="main-content">
    <div class="page-transition" id="pageContent">
      <header class="fade-in-up">
        <h1>Maharaja Institute Of Technology</h1>
        <h2>AI Department - Student Dashboard</h2>
      </header>
      <main class="fade-in-up">
      <h3>Welcome to your dashboard</h3>
      <p>Select an option from the menu to view details.</p>

      <!-- Quick Access Cards -->
      <div class="dashboard-cards stagger-container">
        <div class="dashboard-card" onclick="window.location.href='notifications.html'">
          <h4>📢 Notifications</h4>
          <p>View admin announcements and system messages</p>
          <div id="notificationCount" class="notification-badge">0</div>
        </div>

        <div class="dashboard-card" onclick="window.location.href='assignments.html'">
          <h4>📝 Assignments</h4>
          <p>Check your pending assignments</p>
        </div>

        <div class="dashboard-card" onclick="window.location.href='marks.html'">
          <h4>📊 Marks</h4>
          <p>View your academic performance</p>
        </div>

        <div class="dashboard-card" onclick="window.location.href='attendance.html'">
          <h4>📅 Attendance</h4>
          <p>Check your attendance record</p>
        </div>

        <div class="dashboard-card" onclick="window.location.href='documents.html'">
          <h4>📄 Documents</h4>
          <p>View admin documents and your uploads</p>
          <div id="documentCount" class="notification-badge">0</div>
        </div>
      </div>

      <!-- Recent Notifications Preview -->
      <div class="recent-notifications">
        <h4>Recent Notifications</h4>
        <div id="recentNotificationsPreview">-</div>
      </div>
    </main>
  </div>
  <script src="../js/auth.js"></script>
  <script src="../js/student.js"></script>
  <script>
    // Register service worker for security
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('../sw.js')
        .then(registration => {
          console.log('Service Worker registered for student dashboard');
        })
        .catch(error => {
          console.log('Service Worker registration failed:', error);
        });
    }
  </script>
  <script>
    // Load dashboard data after authentication is verified
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize transitions
      initializeTransitions();
      highlightActiveNav();

      // Load user information for welcome header
      loadUserInfo();

      // Authentication is handled by auth.js, just load dashboard data
      loadNotificationCount();
      loadRecentNotifications();
      loadDocumentCount();
      loadRecentDocuments();
    });

    // Initialize page transitions and animations
    function initializeTransitions() {
      // Add slight delay for smooth page transition
      setTimeout(() => {
        document.getElementById('pageContent').classList.add('show');
      }, 100);

      // Initialize card stagger animations
      setTimeout(() => {
        animateDashboardCards();
      }, 600); // After page transition
    }

    // Animate dashboard cards with stagger effect
    function animateDashboardCards() {
      const cards = document.querySelectorAll('.dashboard-card');
      cards.forEach((card, index) => {
        card.classList.add('stagger-item');
        // Add hover-lift class to cards for better interaction
        if (!card.classList.contains('hover-lift')) {
          card.classList.add('hover-lift');
        }
        // Ensure cards are visible
        card.style.opacity = '1';
        card.style.visibility = 'visible';
        card.style.display = 'block';
      });

      // Ensure parent container is also visible
      const container = document.querySelector('.dashboard-cards');
      if (container) {
        container.style.opacity = '1';
        container.style.visibility = 'visible';
      }
    }

    // Sidebar toggle functionality
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('sidebarOverlay');

      if (window.innerWidth <= 768) {
        sidebar.classList.toggle('show');
        overlay.classList.toggle('show');
      } else {
        sidebar.classList.toggle('collapsed');
      }
    }

    // Close sidebar when clicking overlay
    document.getElementById('sidebarOverlay').addEventListener('click', function() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('sidebarOverlay');
      sidebar.classList.remove('show');
      overlay.classList.remove('show');
    });

    // Close sidebar on window resize if desktop
    window.addEventListener('resize', function() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('sidebarOverlay');

      if (window.innerWidth > 768) {
        sidebar.classList.remove('show');
        overlay.classList.remove('show');
        sidebar.classList.add('collapsed');
      } else {
        sidebar.classList.remove('collapsed');
      }
    });

    // Highlight active navigation link
    function highlightActiveNav() {
      const currentPath = window.location.pathname.split('/').pop();
      const navLinks = document.querySelectorAll('.sidebar-nav a');

      navLinks.forEach(link => {
        link.classList.remove('active');
        if (link.getAttribute('href') === currentPath) {
          link.classList.add('active');
        }
      });
    }

    // Load notification count
    async function loadNotificationCount() {
      try {
        const response = await fetch('/notifications', {
          headers: { 'Authorization': localStorage.getItem('token') }
        });

        if (response.ok) {
          const notifications = await response.json();
          const count = notifications.length;
          document.getElementById('notificationCount').textContent = count;

          // Add visual indicator for new notifications
          if (count > 0) {
            document.getElementById('notificationCount').classList.add('has-notifications');
          }
        }
      } catch (error) {
        console.error('Error loading notification count:', error);
      }
    }

    // Load recent notifications preview
    async function loadRecentNotifications() {
      try {
        const response = await fetch('/notifications', {
          headers: { 'Authorization': localStorage.getItem('token') }
        });

        if (response.ok) {
          const notifications = await response.json();
          const recentNotifications = notifications.slice(0, 3); // Show last 3

          if (recentNotifications.length === 0) {
            document.getElementById('recentNotificationsPreview').innerHTML = '<p>No recent notifications</p>';
          } else {
            let html = '';
            recentNotifications.forEach(notification => {
              const date = new Date(notification.created_at).toLocaleDateString();
              const isAdmin = notification.source === 'admin';

              html += `
                <div class="notification-preview ${isAdmin ? 'admin-preview' : 'student-preview'}">
                  <div class="preview-header">
                    <strong>${notification.title || 'System Notification'}</strong>
                    <small>${date}</small>
                  </div>
                  <p>${notification.message.substring(0, 100)}${notification.message.length > 100 ? '...' : ''}</p>
                </div>
              `;
            });
            html += '<p><a href="notifications.html" class="view-all-link">View all notifications →</a></p>';
            document.getElementById('recentNotificationsPreview').innerHTML = html;
          }
        } else {
          document.getElementById('recentNotificationsPreview').innerHTML = '<p>Error loading notifications</p>';
        }
      } catch (error) {
        console.error('Error loading recent notifications:', error);
        document.getElementById('recentNotificationsPreview').innerHTML = '<p>Error loading notifications</p>';
      }
    }

    // Load document count
    async function loadDocumentCount() {
      try {
        const response = await fetch('/documents', {
          headers: { 'Authorization': localStorage.getItem('token') }
        });

        if (response.ok) {
          const documents = await response.json();
          const count = documents.length;
          document.getElementById('documentCount').textContent = count;

          // Add visual indicator for documents
          if (count > 0) {
            document.getElementById('documentCount').classList.add('has-notifications');
          }
        }
      } catch (error) {
        console.error('Error loading document count:', error);
      }
    }

    // Load recent documents preview
    async function loadRecentDocuments() {
      try {
        const response = await fetch('/documents', {
          headers: { 'Authorization': localStorage.getItem('token') }
        });

        if (response.ok) {
          const documents = await response.json();
          const recentDocuments = documents.slice(0, 3); // Show last 3

          if (recentDocuments.length === 0) {
            // If no documents, don't show the section
            return;
          }

          // Add recent documents section after notifications
          const notificationsSection = document.querySelector('.recent-notifications');
          const documentsSection = document.createElement('div');
          documentsSection.className = 'recent-notifications';
          documentsSection.innerHTML = `
            <h4>Recent Documents</h4>
            <div id="recentDocumentsPreview"></div>
          `;

          notificationsSection.parentNode.insertBefore(documentsSection, notificationsSection.nextSibling);

          let html = '';
          recentDocuments.forEach(doc => {
            const date = new Date(doc.uploaded_at || doc.created_at).toLocaleDateString();
            const isAdmin = doc.source === 'admin';

            html += `
              <div class="document-preview ${isAdmin ? 'admin-preview' : 'student-preview'}">
                <div class="preview-header">
                  <strong>${doc.title}</strong>
                  <small>${date}</small>
                </div>
                <p><em>${doc.original_filename}</em></p>
                ${isAdmin ? '<small style="color: #28a745;">📄 Admin Document</small>' : '<small style="color: #007bff;">📝 Your Document</small>'}
              </div>
            `;
          });
          html += '<p><a href="documents.html" class="view-all-link">View all documents →</a></p>';
          document.getElementById('recentDocumentsPreview').innerHTML = html;
        }
      } catch (error) {
        console.error('Error loading recent documents:', error);
      }
    }

    // Load user information for welcome header
    async function loadUserInfo() {
      try {
        // Try to get profile information first
        const response = await fetch('/profile', {
          headers: { 'Authorization': localStorage.getItem('token') }
        });

        if (response.ok) {
          const userData = await response.json();
          if (userData && userData.name) {
            // Display user's full name
            document.getElementById('userName').textContent = userData.name;
          }
        } else {
          // Fallback: Try to decode JWT token for basic info
          const token = localStorage.getItem('token');
          if (token) {
            try {
              const payload = JSON.parse(atob(token.split('.')[1]));
              if (payload && payload.name) {
                document.getElementById('userName').textContent = payload.name;
              } else if (payload && payload.username) {
                document.getElementById('userName').textContent = payload.username;
              }
            } catch (parseError) {
              console.log('Could not parse token:', parseError);
            }
          }
        }
      } catch (error) {
        console.log('Error loading user info:', error);
        // Keep default "Student" if loading fails
        document.getElementById('userName').textContent = 'Student';
      }
    }
  </script>
</body>
</html>
