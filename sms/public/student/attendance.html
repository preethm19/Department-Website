<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MIT AI SMS - Student Attendance</title>
  <link rel="stylesheet" href="../css/style.css">
  <link rel="stylesheet" href="../css/admin.css">
  <link rel="stylesheet" href="../css/users-modern.css">
  <link rel="stylesheet" href="../css/users-text-fix.css">
  <link rel="stylesheet" href="../css/student-modern.css">
</head>

<body class="student-panel">
  <!-- Sidebar Overlay for Mobile -->
  <div class="sidebar-overlay" id="sidebarOverlay"></div>

  <!-- Sidebar Toggle Button for Mobile -->
  <button class="sidebar-toggle" onclick="toggleSidebar()">â˜°</button>

  <!-- Sidebar Navigation -->
  <div class="admin-sidebar" id="sidebar">
    <div class="sidebar-header">
      <h2>MIT Student</h2>
      <p style="color: rgba(226, 232, 240, 0.7); font-size: 13px; margin: 8px 0 0 0;" id="userName">Welcome, Student</p>
    </div>
    <nav class="sidebar-nav">
      <ul>
        <li><a href="dashboard.html"><span class="icon">ğŸ </span>Dashboard</a></li>
        <li><a href="profile.html"><span class="icon">ğŸ‘¤</span>Profile</a></li>
        <li><a href="classes.html"><span class="icon">ğŸ“š</span>My Classes</a></li>
        <li><a href="assignments.html"><span class="icon">ğŸ“</span>Assignments</a></li>
        <li><a href="attendance.html" class="active"><span class="icon">âœ…</span>Attendance</a></li>
        <li><a href="marks.html"><span class="icon">ğŸ“ˆ</span>My Marks</a></li>
        <li><a href="notifications.html"><span class="icon">ğŸ””</span>Notifications</a></li>
        <li><a href="documents.html"><span class="icon">ğŸ“„</span>Documents</a></li>
      </ul>
    </nav>
    <div class="sidebar-footer">
      <button id="logout" class="btn">Logout</button>
    </div>
  </div>

  <!-- Main Content Area -->
  <div class="main-content">
    <div class="page-transition" id="pageContent">
      <header class="fade-in-up">
        <h1>Maharaja Institute Of Technology</h1>
        <h2>AI Department - My Attendance</h2>
      </header>

      <main class="fade-in-up">
        <!-- Attendance Summary Stats -->
        <div id="attendanceSummary" style="display: none; margin-bottom: 24px;">
          <div class="stats-display">
            <div class="stat-item">
              <div class="stat-value" id="totalClasses">0</div>
              <div class="stat-label">Total Classes</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" style="color: #10b981;" id="presentCount">0</div>
              <div class="stat-label">Present</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" style="color: #ef4444;" id="absentCount">0</div>
              <div class="stat-label">Absent</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="attendancePercentage">0%</div>
              <div class="stat-label">Attendance %</div>
            </div>
          </div>
        </div>

        <!-- Filter Card -->
        <div class="modern-card" style="margin-bottom: 24px;">
          <div class="card-header">
            <div class="card-icon">ğŸ”</div>
            <div>
              <h3 class="card-title">Filter Attendance</h3>
              <p class="card-description">View attendance by date, month, or range</p>
            </div>
          </div>

          <div class="modern-form" style="margin-top: 20px;">
            <!-- Date Filter -->
            <div
              style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 16px;">
              <div class="form-group-modern">
                <label><span class="label-icon">ğŸ“…</span>Select Date</label>
                <input type="date" id="attendanceDate"
                  style="width: 100%; padding: 14px 18px; background: #ffffff; border: 2px solid rgba(96, 165, 250, 0.3); border-radius: 10px; color: #1e293b; font-family: 'Inter', sans-serif; font-size: 15px; box-sizing: border-box;">
              </div>
              <div style="display: flex; align-items: end;">
                <button id="viewAttendance" class="btn-modern" style="width: 100%;">
                  <span class="btn-icon">ğŸ‘ï¸</span>View Date
                </button>
              </div>
            </div>

            <!-- Month Filter -->
            <div
              style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin-bottom: 16px;">
              <div class="form-group-modern">
                <label><span class="label-icon">ğŸ“†</span>Month</label>
                <select id="monthSelect"
                  style="width: 100%; padding: 14px 18px; background: #ffffff; border: 2px solid rgba(96, 165, 250, 0.3); border-radius: 10px; color: #1e293b; font-family: 'Inter', sans-serif; font-size: 15px; box-sizing: border-box;">
                  <option value="">Choose Month</option>
                  <option value="01">January</option>
                  <option value="02">February</option>
                  <option value="03">March</option>
                  <option value="04">April</option>
                  <option value="05">May</option>
                  <option value="06">June</option>
                  <option value="07">July</option>
                  <option value="08">August</option>
                  <option value="09">September</option>
                  <option value="10">October</option>
                  <option value="11">November</option>
                  <option value="12">December</option>
                </select>
              </div>
              <div class="form-group-modern">
                <label><span class="label-icon">ğŸ“…</span>Year</label>
                <select id="yearSelect"
                  style="width: 100%; padding: 14px 18px; background: #ffffff; border: 2px solid rgba(96, 165, 250, 0.3); border-radius: 10px; color: #1e293b; font-family: 'Inter', sans-serif; font-size: 15px; box-sizing: border-box;">
                  <option value="2025">2025</option>
                  <option value="2024">2024</option>
                  <option value="2023">2023</option>
                </select>
              </div>
              <div style="display: flex; align-items: end;">
                <button id="viewMonthAttendance" class="btn-modern"
                  style="width: 100%; background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                  <span class="btn-icon">ğŸ‘ï¸</span>View Month
                </button>
              </div>
            </div>

            <!-- Range Filter -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px;">
              <div class="form-group-modern">
                <label><span class="label-icon">ğŸ“…</span>From Date</label>
                <input type="date" id="dateFrom"
                  style="width: 100%; padding: 14px 18px; background: #ffffff; border: 2px solid rgba(96, 165, 250, 0.3); border-radius: 10px; color: #1e293b; font-family: 'Inter', sans-serif; font-size: 15px; box-sizing: border-box;">
              </div>
              <div class="form-group-modern">
                <label><span class="label-icon">ğŸ“…</span>To Date</label>
                <input type="date" id="dateTo"
                  style="width: 100%; padding: 14px 18px; background: #ffffff; border: 2px solid rgba(96, 165, 250, 0.3); border-radius: 10px; color: #1e293b; font-family: 'Inter', sans-serif; font-size: 15px; box-sizing: border-box;">
              </div>
              <div style="display: flex; align-items: end; gap: 8px;">
                <button id="viewRangeAttendance" class="btn-modern"
                  style="flex: 1; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                  <span class="btn-icon">ğŸ‘ï¸</span>View Range
                </button>
                <button id="viewAllAttendance" class="btn-modern btn-secondary" style="flex: 1;">
                  <span class="btn-icon">ğŸ“‹</span>View All
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Attendance Records Card -->
        <div class="modern-card">
          <div class="card-header">
            <div class="card-icon">ğŸ“Š</div>
            <div>
              <h3 class="card-title">Attendance Records</h3>
              <p class="card-description">Your attendance history</p>
            </div>
          </div>

          <div id="attendance" style="margin-top: 24px;">
            <p style="text-align: center; color: #64748b; padding: 40px 20px;">Loading attendance...</p>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- Toast Container -->
  <div class="toast-container" id="toastContainer"></div>

  <script src="../js/auth.js"></script>
  <script src="../js/student.js"></script>
  <script>
    let allAttendanceData = [];

    // Toast notification
    function showToast(type, title, message) {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      const icons = { success: 'âœ“', error: 'âœ•', info: 'â„¹' };
      toast.innerHTML = `
        <span class="toast-icon">${icons[type]}</span>
        <div class="toast-content">
          <div class="toast-title">${title}</div>
          <div class="toast-message">${message}</div>
        </div>
        <button class="toast-close" onclick="this.parentElement.remove()">Ã—</button>
      `;
      container.appendChild(toast);
      setTimeout(() => {
        toast.style.animation = 'slideIn 0.3s ease-out reverse';
        setTimeout(() => toast.remove(), 300);
      }, 5000);
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function () {
      setTimeout(() => {
        document.getElementById('pageContent').classList.add('show');
      }, 100);
      loadUserInfo();
      loadAllAttendance();
    });

    // Sidebar functions
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('sidebarOverlay');
      if (window.innerWidth <= 768) {
        sidebar.classList.toggle('show');
        overlay.classList.toggle('show');
      }
    }

    document.getElementById('sidebarOverlay').addEventListener('click', toggleSidebar);

    // Load user info
    async function loadUserInfo() {
      try {
        const response = await fetch('/profile', {
          headers: { 'Authorization': localStorage.getItem('token') }
        });
        if (response.ok) {
          const userData = await response.json();
          if (userData && userData.name) {
            document.getElementById('userName').textContent = `Welcome, ${userData.name}`;
          }
        }
      } catch (error) {
        console.log('Error loading user info:', error);
      }
    }

    // Load all attendance
    async function loadAllAttendance() {
      try {
        const response = await fetch('/attendance', {
          headers: { 'Authorization': localStorage.getItem('token') }
        });
        if (response.ok) {
          allAttendanceData = await response.json();
          displayAttendanceSummary(allAttendanceData);
          displayAttendanceRecords(allAttendanceData);
        } else {
          document.getElementById('attendance').innerHTML = '<p style="text-align: center; color: #ef4444; padding: 40px 20px;">Error loading attendance</p>';
        }
      } catch (error) {
        console.error('Error loading attendance:', error);
        document.getElementById('attendance').innerHTML = '<p style="text-align: center; color: #ef4444; padding: 40px 20px;">Error loading attendance</p>';
      }
    }

    // Display summary
    function displayAttendanceSummary(data) {
      const totalClasses = data.length;
      const presentCount = data.filter(r => r.status === 'present').length;
      const absentCount = data.filter(r => r.status === 'absent').length;
      const percentage = totalClasses > 0 ? Math.round((presentCount / totalClasses) * 100) : 0;

      document.getElementById('totalClasses').textContent = totalClasses;
      document.getElementById('presentCount').textContent = presentCount;
      document.getElementById('absentCount').textContent = absentCount;
      document.getElementById('attendancePercentage').textContent = percentage + '%';

      const percentageEl = document.getElementById('attendancePercentage');
      if (percentage >= 85) percentageEl.style.color = '#10b981';
      else if (percentage >= 75) percentageEl.style.color = '#3b82f6';
      else if (percentage >= 60) percentageEl.style.color = '#f59e0b';
      else percentageEl.style.color = '#ef4444';

      document.getElementById('attendanceSummary').style.display = totalClasses > 0 ? 'block' : 'none';
    }

    // Display records
    function displayAttendanceRecords(data) {
      if (data.length === 0) {
        document.getElementById('attendance').innerHTML = '<p style="text-align: center; color: #64748b; padding: 40px 20px;">No attendance records found</p>';
        return;
      }

      let html = '<div style="display: grid; gap: 12px;">';
      data.forEach(record => {
        const dateStr = record.date.split('T')[0];
        const dateParts = dateStr.split('-');
        const date = `${dateParts[2]}/${dateParts[1]}/${dateParts[0]}`;
        const isPresent = record.status === 'present';
        const bgColor = isPresent ? 'rgba(16, 185, 129, 0.1)' : 'rgba(239, 68, 68, 0.1)';
        const borderColor = isPresent ? 'rgba(16, 185, 129, 0.2)' : 'rgba(239, 68, 68, 0.2)';
        const statusColor = isPresent ? '#10b981' : '#ef4444';
        const statusIcon = isPresent ? 'âœ…' : 'âŒ';

        html += `
          <div style="background: ${bgColor}; border: 1px solid ${borderColor}; border-radius: 12px; padding: 16px;">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
              <div style="flex: 1;">
                <h4 style="color: #1e293b; font-size: 16px; font-weight: 700; margin: 0 0 4px 0;">${record.subject_name}</h4>
                <p style="color: #64748b; font-size: 13px; margin: 0;">ğŸ“… ${date}</p>
              </div>
              <div style="text-align: right;">
                <span style="background: ${statusColor}; color: white; padding: 6px 16px; border-radius: 20px; font-size: 13px; font-weight: 600; display: inline-flex; align-items: center; gap: 6px;">
                  ${statusIcon} ${record.status.toUpperCase()}
                </span>
              </div>
            </div>
          </div>
        `;
      });
      html += '</div>';
      document.getElementById('attendance').innerHTML = html;
    }

    // View date
    document.getElementById('viewAttendance').addEventListener('click', function () {
      const selectedDate = document.getElementById('attendanceDate').value;
      if (!selectedDate) {
        showToast('error', 'Date Required', 'Please select a date');
        return;
      }
      const filtered = allAttendanceData.filter(r => r.date.split('T')[0] === selectedDate);
      if (filtered.length === 0) {
        document.getElementById('attendance').innerHTML = '<p style="text-align: center; color: #64748b; padding: 40px 20px;">No records for this date</p>';
        document.getElementById('attendanceSummary').style.display = 'none';
      } else {
        displayAttendanceSummary(filtered);
        displayAttendanceRecords(filtered);
      }
    });

    // View month
    document.getElementById('viewMonthAttendance').addEventListener('click', function () {
      const month = document.getElementById('monthSelect').value;
      const year = document.getElementById('yearSelect').value;
      if (!month || !year) {
        showToast('error', 'Selection Required', 'Please select both month and year');
        return;
      }
      const filtered = allAttendanceData.filter(r => {
        const dateStr = r.date.split('T')[0];
        const recordDate = new Date(dateStr + 'T00:00:00');
        const recordMonth = String(recordDate.getMonth() + 1).padStart(2, '0');
        const recordYear = String(recordDate.getFullYear());
        return recordMonth === month && recordYear === year;
      });
      if (filtered.length === 0) {
        document.getElementById('attendance').innerHTML = '<p style="text-align: center; color: #64748b; padding: 40px 20px;">No records for this month</p>';
        document.getElementById('attendanceSummary').style.display = 'none';
      } else {
        displayAttendanceSummary(filtered);
        displayAttendanceRecords(filtered);
      }
    });

    // View range
    document.getElementById('viewRangeAttendance').addEventListener('click', function () {
      const dateFrom = document.getElementById('dateFrom').value;
      const dateTo = document.getElementById('dateTo').value;
      if (!dateFrom || !dateTo) {
        showToast('error', 'Dates Required', 'Please select both from and to dates');
        return;
      }
      if (new Date(dateFrom) > new Date(dateTo)) {
        showToast('error', 'Invalid Range', 'From date cannot be later than to date');
        return;
      }
      const filtered = allAttendanceData.filter(r => {
        const dateStr = r.date.split('T')[0];
        return dateStr >= dateFrom && dateStr <= dateTo;
      });
      if (filtered.length === 0) {
        document.getElementById('attendance').innerHTML = '<p style="text-align: center; color: #64748b; padding: 40px 20px;">No records for this range</p>';
        document.getElementById('attendanceSummary').style.display = 'none';
      } else {
        displayAttendanceSummary(filtered);
        displayAttendanceRecords(filtered);
      }
    });

    // View all
    document.getElementById('viewAllAttendance').addEventListener('click', function () {
      displayAttendanceSummary(allAttendanceData);
      displayAttendanceRecords(allAttendanceData);
    });
  </script>
</body>

</html>