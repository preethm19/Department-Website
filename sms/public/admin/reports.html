<!DOCTYPE html>
<html lang="en" class="admin-panel">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MIT AI SMS - Admin Reports</title>
  <link rel="stylesheet" href="../css/style.css">
  <link rel="stylesheet" href="../css/admin.css">
</head>
<body>
  <!-- Sidebar Overlay for Mobile -->
  <div class="sidebar-overlay" id="sidebarOverlay"></div>

  <!-- Sidebar Toggle Button for Mobile -->
  <button class="sidebar-toggle" onclick="toggleSidebar()">‚ò∞</button>

  <!-- Sidebar Navigation -->
  <div class="admin-sidebar" id="sidebar">
    <div class="sidebar-header">
      <h2>MIT Admin</h2>
    </div>
    <nav class="sidebar-nav">
      <ul>
        <li><a href="dashboard.html"><span class="icon">üìä</span>Dashboard</a></li>
        <li><a href="users.html"><span class="icon">üë•</span>Manage Users</a></li>
        <li><a href="classes.html"><span class="icon">üìö</span>Manage Subjects</a></li>
        <li><a href="assignments.html"><span class="icon">üìù</span>Manage Assignments</a></li>
        <li><a href="materials.html"><span class="icon">üìñ</span>Manage Materials</a></li>
        <li><a href="attendance.html"><span class="icon">‚úÖ</span>Mark Attendance</a></li>
        <li><a href="grades.html"><span class="icon">üìà</span>Upload Results</a></li>
        <li><a href="reports.html" class="active"><span class="icon">üìã</span>Reports</a></li>
        <li><a href="notifications.html"><span class="icon">üîî</span>Send Notifications</a></li>
        <li><a href="documents.html"><span class="icon">üìÑ</span>Documents</a></li>
      </ul>
    </nav>
    <div class="sidebar-footer">
      <button id="logout" class="btn">Logout</button>
    </div>
  </div>

  <!-- Main Content Area -->
  <div class="main-content">
    <div class="page-transition" id="pageContent">
      <header class="fade-in-up">
        <h1>Maharaja Institute Of Technology</h1>
        <h2>AI Department - Reports & Analytics</h2>
      </header>
      <main class="fade-in-up">
      <h3>System Reports & Analytics</h3>

      <div class="reports-section">
        <h4>Quick Statistics</h4>
        <div class="stats-grid">
          <div class="stat-card">
            <h5>Total Students</h5>
            <div id="totalStudents">-</div>
          </div>
          <div class="stat-card">
            <h5>Total Admins</h5>
            <div id="totalAdmins">-</div>
          </div>
          <div class="stat-card">
            <h5>Total Subjects</h5>
            <div id="totalSubjects">-</div>
          </div>
          <div class="stat-card">
            <h5>Active Assignments</h5>
            <div id="totalAssignments">-</div>
          </div>
        </div>
      </div>

      <div class="reports-section">
        <h4>Student Distribution by Semester</h4>
        <div id="semesterChart">-</div>
      </div>

      <div class="reports-section">
        <h4>Recent Activity</h4>
        <div id="recentActivity">-</div>
      </div>

      <div class="reports-section">
        <h4>Export Reports</h4>
        <button onclick="exportReport('students')" class="btn">Export Student Report</button>
        <button onclick="exportReport('attendance')" class="btn">Export Attendance Report</button>
        <button onclick="exportReport('grades')" class="btn">Export Grades Report</button>
        <div id="exportMessage"></div>
      </div>
    </main>
  </div>
  <script src="../js/auth.js"></script>
  <script src="../js/admin.js"></script>
  <script>
    // Sidebar toggle functionality
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('sidebarOverlay');

      if (window.innerWidth <= 768) {
        sidebar.classList.toggle('show');
        overlay.classList.toggle('show');
      } else {
        sidebar.classList.toggle('collapsed');
      }
    }

    // Close sidebar when clicking overlay
    document.getElementById('sidebarOverlay').addEventListener('click', function() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('sidebarOverlay');
      sidebar.classList.remove('show');
      overlay.classList.remove('show');
    });

    // Close sidebar on window resize if desktop
    window.addEventListener('resize', function() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('sidebarOverlay');

      if (window.innerWidth > 768) {
        sidebar.classList.remove('show');
        overlay.classList.remove('show');
        sidebar.classList.add('collapsed');
      } else {
        sidebar.classList.remove('collapsed');
      }
    });

    // Highlight active navigation link
    function highlightActiveNav() {
      const currentPath = window.location.pathname.split('/').pop();
      const navLinks = document.querySelectorAll('.sidebar-nav a');

      navLinks.forEach(link => {
        link.classList.remove('active');
        if (link.getAttribute('href') === currentPath) {
          link.classList.add('active');
        }
      });
    }

    // Load reports after authentication
    document.addEventListener('DOMContentLoaded', function() {
      initializeTransitions();
      highlightActiveNav();
      loadStatistics();
      loadSemesterDistribution();
      loadRecentActivity();
    });

    // Initialize page transitions
    function initializeTransitions() {
      setTimeout(() => {
        document.getElementById('pageContent').classList.add('show');
      }, 100);

      const navLinks = document.querySelectorAll('.nav-list a');
      navLinks.forEach(link => {
        link.addEventListener('click', function(e) {
          this.style.transform = 'scale(0.95)';
          setTimeout(() => this.style.transform = '', 150);
        });
      });

      const buttons = document.querySelectorAll('.btn');
      buttons.forEach(button => {
        if (!button.classList.contains('hover-lift')) {
          button.classList.add('hover-lift');
        }
      });
    }

    // Load system statistics
    async function loadStatistics() {
      try {
        // Get total students
        const studentsResponse = await fetch('/admin/users?userType=students', {
          headers: { 'Authorization': localStorage.getItem('token') }
        });
        const students = await studentsResponse.json();
        document.getElementById('totalStudents').textContent = students.length;

        // Get total admins
        const adminsResponse = await fetch('/admin/users?userType=admins', {
          headers: { 'Authorization': localStorage.getItem('token') }
        });
        const admins = await adminsResponse.json();
        document.getElementById('totalAdmins').textContent = admins.length;

        // Get total subjects
        const subjectsResponse = await fetch('/admin/classes', {
          headers: { 'Authorization': localStorage.getItem('token') }
        });
        const subjects = await subjectsResponse.json();
        document.getElementById('totalSubjects').textContent = subjects.length;

        // Get total assignments
        const assignmentsResponse = await fetch('/admin/assignments', {
          headers: { 'Authorization': localStorage.getItem('token') }
        });
        const assignments = await assignmentsResponse.json();
        document.getElementById('totalAssignments').textContent = assignments.length;

      } catch (error) {
        console.error('Error loading statistics:', error);
      }
    }

    // Load semester distribution
    async function loadSemesterDistribution() {
      try {
        const response = await fetch('/admin/users?userType=students', {
          headers: { 'Authorization': localStorage.getItem('token') }
        });
        const students = await response.json();

        const semesterCount = {};
        students.forEach(student => {
          const semester = student.semester || 'Unknown';
          semesterCount[semester] = (semesterCount[semester] || 0) + 1;
        });

        let html = '<div class="semester-distribution">';
        Object.keys(semesterCount).sort().forEach(semester => {
          html += `<div class="semester-item">
            <span>Semester ${semester}:</span>
            <span>${semesterCount[semester]} students</span>
          </div>`;
        });
        html += '</div>';

        document.getElementById('semesterChart').innerHTML = html;

      } catch (error) {
        console.error('Error loading semester distribution:', error);
        document.getElementById('semesterChart').innerHTML = 'Error loading data';
      }
    }

    // Load recent activity
    async function loadRecentActivity() {
      try {
        // This would typically fetch from an activity log table
        // For now, show recent user additions
        const response = await fetch('/admin/users?userType=all', {
          headers: { 'Authorization': localStorage.getItem('token') }
        });
        const users = await response.json();

        // Sort by ID (assuming higher ID = more recent)
        const recentUsers = users
          .sort((a, b) => b.id - a.id)
          .slice(0, 5);

        let html = '<ul class="activity-list">';
        recentUsers.forEach(user => {
          const role = user.role === 'admin' ? 'Admin' : 'Student';
          html += `<li>${role} "${user.name}" added to system</li>`;
        });
        html += '</ul>';

        document.getElementById('recentActivity').innerHTML = html;

      } catch (error) {
        console.error('Error loading recent activity:', error);
        document.getElementById('recentActivity').innerHTML = 'Error loading data';
      }
    }

    // Export reports
    async function exportReport(type) {
      try {
        let endpoint = '';
        let filename = '';

        switch (type) {
          case 'students':
            endpoint = '/admin/export-users';
            filename = 'student_report.csv';
            break;
          case 'attendance':
            // This would need a new endpoint for attendance reports
            alert('Attendance report export coming soon');
            return;
          case 'grades':
            // This would need a new endpoint for grades reports
            alert('Grades report export coming soon');
            return;
        }

        const response = await fetch(endpoint, {
          headers: { 'Authorization': localStorage.getItem('token') }
        });

        if (!response.ok) {
          const error = await response.json();
          document.getElementById('exportMessage').innerText = error.error || 'Export failed';
          return;
        }

        const blob = await response.blob();

        // Get filename from response headers
        const contentDisposition = response.headers.get('Content-Disposition');
        let downloadFilename = filename;
        if (contentDisposition) {
          const matches = contentDisposition.match(/filename="([^"]+)"/);
          if (matches) downloadFilename = matches[1];
        }

        // Create download link
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = downloadFilename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);

        document.getElementById('exportMessage').innerText = 'Report exported successfully';

      } catch (error) {
        console.error('Export error:', error);
        document.getElementById('exportMessage').innerText = 'Export failed';
      }
    }
  </script>
</body>
</html>
