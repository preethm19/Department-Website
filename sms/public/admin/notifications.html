<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MIT AI SMS - Admin Notifications</title>
  <link rel="stylesheet" href="../css/style.css">
</head>
<body>
  <div class="container">
    <header>
      <h1>Maharaja Institute Of Technology</h1>
      <h2>AI Department - Send Notifications</h2>
      <button id="logout" class="btn">Logout</button>
    </header>
    <nav>
      <button class="nav-toggle" onclick="toggleNav()">â˜° Menu</button>
      <ul class="nav-list" id="navList">
        <li><a href="dashboard.html">Dashboard</a></li>
        <li><a href="users.html">Manage Users</a></li>
        <li><a href="classes.html">Manage Subjects</a></li>
        <li><a href="assignments.html">Manage Assignments</a></li>
        <li><a href="materials.html">Manage Materials</a></li>
        <li><a href="attendance.html">Mark Attendance</a></li>
        <li><a href="grades.html">Upload Results</a></li>
        <li><a href="reports.html">Reports</a></li>
        <li><a href="notifications.html">Send Notifications</a></li>
        <li><a href="documents.html">Documents</a></li>
      </ul>
    </nav>
    <main>
      <h3>Send Notifications to Users</h3>

      <div class="notification-form">
        <form id="sendNotificationForm">
          <div class="form-group">
            <label for="notificationTitle">Notification Title:</label>
            <input type="text" id="notificationTitle" required placeholder="e.g., Assignment Deadline">
          </div>

          <div class="form-group">
            <label for="notificationMessage">Message:</label>
            <textarea id="notificationMessage" required rows="4" placeholder="Enter your notification message here..."></textarea>
          </div>

          <div class="form-group">
            <label for="recipientType">Send to:</label>
            <select id="recipientType" required>
              <option value="">Select Recipients</option>
              <option value="all">All Users</option>
              <option value="students">All Students</option>
              <option value="admins">All Admins</option>
              <option value="specific">Specific User</option>
            </select>
          </div>

          <div class="form-group" id="specificUserGroup" style="display: none;">
            <label for="specificUser">Select User:</label>
            <select id="specificUser">
              <option value="">Select User</option>
            </select>
          </div>

          <div class="form-group" id="semesterGroup" style="display: none;">
            <label for="semesterSelect">Filter by Semester (Students only):</label>
            <select id="semesterSelect">
              <option value="all">All Semesters</option>
              <option value="1">Semester 1</option>
              <option value="2">Semester 2</option>
              <option value="3">Semester 3</option>
              <option value="4">Semester 4</option>
              <option value="5">Semester 5</option>
              <option value="6">Semester 6</option>
              <option value="7">Semester 7</option>
              <option value="8">Semester 8</option>
            </select>
          </div>

          <button type="submit" class="btn">Send Notification</button>
        </form>
        <div id="notificationMessage"></div>
      </div>

      <div class="notification-history">
        <h4>Recent Notifications</h4>
        <div id="notificationHistory">-</div>
      </div>
    </main>
  </div>
  <script src="../js/auth.js"></script>
  <script src="../js/admin.js"></script>
  <script>
    // Mobile navigation toggle
    function toggleNav() {
      const navList = document.getElementById('navList');
      navList.classList.toggle('show');
    }

    // Handle recipient type change
    document.getElementById('recipientType').addEventListener('change', function() {
      const recipientType = this.value;
      const specificUserGroup = document.getElementById('specificUserGroup');
      const semesterGroup = document.getElementById('semesterGroup');

      if (recipientType === 'specific') {
        specificUserGroup.style.display = 'block';
        semesterGroup.style.display = 'none';
        loadUsers();
      } else if (recipientType === 'students') {
        specificUserGroup.style.display = 'none';
        semesterGroup.style.display = 'block';
      } else {
        specificUserGroup.style.display = 'none';
        semesterGroup.style.display = 'none';
      }
    });

    // Load users for specific user selection
    async function loadUsers() {
      try {
        const response = await fetch('/admin/users?userType=all', {
          headers: { 'Authorization': localStorage.getItem('token') }
        });
        const users = await response.json();

        const select = document.getElementById('specificUser');
        select.innerHTML = '<option value="">Select User</option>';

        users.forEach(user => {
          const role = user.role === 'admin' ? 'Admin' : 'Student';
          const identifier = user.role === 'admin' ? user.email : user.usn;
          const option = document.createElement('option');
          option.value = user.id;
          option.textContent = `${user.name} (${role} - ${identifier})`;
          select.appendChild(option);
        });
      } catch (error) {
        console.error('Error loading users:', error);
      }
    }

    // Send notification form handler
    document.getElementById('sendNotificationForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const title = document.getElementById('notificationTitle').value;
      const message = document.getElementById('notificationMessage').value;
      const recipientType = document.getElementById('recipientType').value;
      const specificUser = document.getElementById('specificUser').value;
      const semester = document.getElementById('semesterSelect').value;

      if (!title || !message || !recipientType) {
        document.getElementById('notificationMessage').innerText = 'Please fill in all required fields';
        return;
      }

      if (recipientType === 'specific' && !specificUser) {
        document.getElementById('notificationMessage').innerText = 'Please select a specific user';
        return;
      }

      try {
        const notificationData = {
          title,
          message,
          recipientType,
          specificUser: specificUser || null,
          semester: semester || null
        };

        const response = await fetch('/admin/send-notification', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': localStorage.getItem('token')
          },
          body: JSON.stringify(notificationData)
        });

        const data = await response.json();

        if (response.ok) {
          document.getElementById('notificationMessage').innerText = 'Notification sent successfully!';
          document.getElementById('sendNotificationForm').reset();
          loadNotificationHistory();
        } else {
          document.getElementById('notificationMessage').innerText = data.error || 'Failed to send notification';
        }
      } catch (error) {
        console.error('Error sending notification:', error);
        document.getElementById('notificationMessage').innerText = 'Error sending notification';
      }
    });

    // Load notification history on page load
    document.addEventListener('DOMContentLoaded', function() {
      loadNotificationHistory();
    });

    // Load notification history
    async function loadNotificationHistory() {
      try {
        const response = await fetch('/admin/notifications', {
          headers: { 'Authorization': localStorage.getItem('token') }
        });

        if (response.ok) {
          const notifications = await response.json();

          if (notifications.length === 0) {
            document.getElementById('notificationHistory').innerHTML = '<p>No notifications sent yet.</p>';
          } else {
            let html = '<div class="notifications-grid">';
            notifications.slice(0, 10).forEach(notification => {
              const date = new Date(notification.created_at).toLocaleDateString();
              html += `
                <div class="notification-card">
                  <div class="notification-header">
                    <h5>${notification.title || 'Notification'}</h5>
                    <div class="notification-actions">
                      <button onclick="editNotification(${notification.id}, '${notification.title}', '${notification.message.replace(/'/g, "\\'")}')" class="btn edit-btn">Edit</button>
                      <button onclick="deleteNotification(${notification.id}, '${notification.title}')" class="btn delete-btn">Delete</button>
                    </div>
                  </div>
                  <div class="notification-content">
                    <p>${notification.message}</p>
                  </div>
                  <div class="notification-footer">
                    <small>Sent: ${date} | Recipients: ${notification.recipient_type || 'All Users'}</small>
                  </div>
                </div>
              `;
            });
            html += '</div>';
            document.getElementById('notificationHistory').innerHTML = html;
          }
        } else {
          document.getElementById('notificationHistory').innerHTML = '<p>Error loading notification history.</p>';
        }
      } catch (error) {
        console.error('Error loading notification history:', error);
        document.getElementById('notificationHistory').innerHTML = '<p>Error loading notification history.</p>';
      }
    }

    // Edit notification
    async function editNotification(notificationId, currentTitle, currentMessage) {
      // Create edit modal
      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.innerHTML = `
        <div class="modal-content">
          <div class="modal-header">
            <h3>Edit Notification</h3>
            <span class="close" onclick="this.closest('.modal').remove()">&times;</span>
          </div>
          <div class="modal-body">
            <form id="editNotificationForm">
              <div class="form-group">
                <label for="editTitle">Notification Title:</label>
                <input type="text" id="editTitle" value="${currentTitle}" required>
              </div>
              <div class="form-group">
                <label for="editMessage">Message:</label>
                <textarea id="editMessage" rows="4" required>${currentMessage}</textarea>
              </div>
            </form>
          </div>
          <div class="modal-actions">
            <button onclick="this.closest('.modal').remove()" class="btn">Cancel</button>
            <button onclick="saveNotificationEdit(${notificationId})" class="btn">Save Changes</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    // Save notification edit
    async function saveNotificationEdit(notificationId) {
      const title = document.getElementById('editTitle').value;
      const message = document.getElementById('editMessage').value;

      if (!title || !message) {
        alert('Please fill in all fields');
        return;
      }

      try {
        const response = await fetch(`/admin/notifications/${notificationId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': localStorage.getItem('token')
          },
          body: JSON.stringify({ title, message })
        });

        const data = await response.json();

        if (response.ok) {
          alert('Notification updated successfully!');
          document.querySelector('.modal').remove();
          loadNotificationHistory();
        } else {
          alert(data.error || 'Failed to update notification');
        }
      } catch (error) {
        console.error('Error updating notification:', error);
        alert('Error updating notification');
      }
    }

    // Delete notification
    async function deleteNotification(notificationId, notificationTitle) {
      if (confirm(`Are you sure you want to delete the notification "${notificationTitle}"? This action cannot be undone.`)) {
        try {
          const response = await fetch(`/admin/notifications/${notificationId}`, {
            method: 'DELETE',
            headers: { 'Authorization': localStorage.getItem('token') }
          });

          const data = await response.json();

          if (response.ok) {
            alert('Notification deleted successfully!');
            loadNotificationHistory();
          } else {
            alert(data.error || 'Failed to delete notification');
          }
        } catch (error) {
          console.error('Error deleting notification:', error);
          alert('Error deleting notification');
        }
      }
    }
  </script>
</body>
</html>
