<!DOCTYPE html>
<html lang="en" class="admin-panel">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>MIT AI SMS - Admin Dashboard</title>
  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="32x32" href="../images/logo.png">
  <link rel="icon" type="image/png" sizes="16x16" href="../images/logo.png">
  <link rel="icon" type="image/x-icon" href="../images/logo.png">
  <link rel="shortcut icon" type="image/x-icon" href="../images/logo.png">
  <link rel="apple-touch-icon" sizes="180x180" href="../images/logo.png">
  <link rel="icon" sizes="192x192" href="../images/logo.png">
  <meta name="msapplication-TileImage" content="../images/logo.png">
  <meta name="msapplication-TileColor" content="#4f46e5">
  <link rel="stylesheet" href="../css/style.css">
  <link rel="stylesheet" href="../css/admin.css">
  <link rel="stylesheet" href="../css/admin-modern.css">
</head>

<body>
  <!-- Sidebar Overlay for Mobile -->
  <div class="sidebar-overlay" id="sidebarOverlay"></div>

  <!-- Sidebar Toggle Button for Mobile -->
  <button class="sidebar-toggle" onclick="toggleSidebar()">‚ò∞</button>

  <!-- Sidebar Navigation -->
  <div class="admin-sidebar" id="sidebar">
    <div class="sidebar-header">
      <h2>MIT Admin</h2>
    </div>
    <nav class="sidebar-nav">
      <ul>
        <li><a href="dashboard.html" class="active"><span class="icon">üìä</span>Dashboard</a></li>
        <li><a href="users.html"><span class="icon">üë•</span>Manage Users</a></li>
        <li><a href="classes.html"><span class="icon">üìö</span>Manage Subjects</a></li>
        <li><a href="assignments.html"><span class="icon">üìù</span>Manage Assignments</a></li>
        <li><a href="materials.html"><span class="icon">üìñ</span>Manage Materials</a></li>
        <li><a href="attendance.html"><span class="icon">‚úÖ</span>Mark Attendance</a></li>
        <li><a href="grades.html"><span class="icon">üìà</span>Upload Results</a></li>
        <li><a href="reports.html"><span class="icon">üìã</span>Reports</a></li>
        <li><a href="notifications.html"><span class="icon">üîî</span>Send Notifications</a></li>
        <li><a href="documents.html"><span class="icon">üìÑ</span>Documents</a></li>
      </ul>
    </nav>
    <div class="sidebar-footer">
      <button id="logout" class="btn">Logout</button>
    </div>
  </div>

  <!-- Main Content Area -->
  <div class="main-content">
    <div class="page-transition" id="pageContent">
      <header class="fade-in-up">
        <h1>Maharaja Institute Of Technology</h1>
        <h2>AI Department - Admin Dashboard</h2>
      </header>
      <main class="fade-in-up">
        <h3>Welcome to Admin Dashboard</h3>
        <p style="color: #64748b; margin-bottom: 30px;">Monitor and manage your academic system</p>

        <!-- Modern Statistics Cards -->
        <div class="stats-grid-enhanced"
          style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 40px;">
          <!-- Total Students Card -->
          <div class="stat-card-enhanced"
            style="background: linear-gradient(135deg, rgba(66, 153, 225, 0.1) 0%, rgba(49, 130, 206, 0.05) 100%); border: 2px solid rgba(66, 153, 225, 0.2); border-radius: 12px; padding: 24px; transition: all 0.3s ease;">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
              <span style="font-size: 32px;">üë•</span>
              <span
                style="font-size: 12px; color: #10b981; font-weight: 600; background: rgba(16, 185, 129, 0.1); padding: 4px 8px; border-radius: 12px;">‚Üë
                12%</span>
            </div>
            <div
              style="font-size: 14px; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">
              Total Students</div>
            <div id="totalStudents" style="font-size: 32px; font-weight: 700; color: #1e293b;">0</div>
          </div>

          <!-- Active Subjects Card -->
          <div class="stat-card-enhanced"
            style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.1) 0%, rgba(124, 58, 237, 0.05) 100%); border: 2px solid rgba(139, 92, 246, 0.2); border-radius: 12px; padding: 24px; transition: all 0.3s ease;">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
              <span style="font-size: 32px;">üìö</span>
              <span
                style="font-size: 12px; color: #10b981; font-weight: 600; background: rgba(16, 185, 129, 0.1); padding: 4px 8px; border-radius: 12px;">‚Üë
                2</span>
            </div>
            <div
              style="font-size: 14px; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">
              Active Subjects</div>
            <div id="totalSubjects" style="font-size: 32px; font-weight: 700; color: #1e293b;">0</div>
          </div>

          <!-- Attendance Card -->
          <div class="stat-card-enhanced"
            style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(5, 150, 105, 0.05) 100%); border: 2px solid rgba(16, 185, 129, 0.2); border-radius: 12px; padding: 24px; transition: all 0.3s ease;">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
              <span style="font-size: 32px;">‚úÖ</span>
              <span
                style="font-size: 12px; color: #10b981; font-weight: 600; background: rgba(16, 185, 129, 0.1); padding: 4px 8px; border-radius: 12px;">‚Üë
                3.2%</span>
            </div>
            <div
              style="font-size: 14px; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">
              Avg Attendance</div>
            <div id="avgAttendance" style="font-size: 32px; font-weight: 700; color: #1e293b;">0%</div>
          </div>

          <!-- Assignments Card -->
          <div class="stat-card-enhanced"
            style="background: linear-gradient(135deg, rgba(251, 146, 60, 0.1) 0%, rgba(249, 115, 22, 0.05) 100%); border: 2px solid rgba(251, 146, 60, 0.2); border-radius: 12px; padding: 24px; transition: all 0.3s ease;">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
              <span style="font-size: 32px;">üìù</span>
              <span
                style="font-size: 12px; color: #ef4444; font-weight: 600; background: rgba(239, 68, 68, 0.1); padding: 4px 8px; border-radius: 12px;">5
                pending</span>
            </div>
            <div
              style="font-size: 14px; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">
              Total Assignments</div>
            <div id="totalAssignments" style="font-size: 32px; font-weight: 700; color: #1e293b;">0</div>
          </div>
        </div>

        <div class="user-management-section"
          style="background: white; border-radius: 12px; padding: 30px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); border: 1px solid rgba(66, 153, 225, 0.1);">
          <h4 style="color: #1e293b; margin-bottom: 20px; font-size: 20px;">User Management</h4>
          <div class="user-filters" style="display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 25px;">
            <div class="form-group" style="flex: 1; min-width: 200px;">
              <label for="userTypeSelect"
                style="display: block; margin-bottom: 8px; color: #475569; font-weight: 600; font-size: 14px;">User
                Type:</label>
              <select id="userTypeSelect"
                style="width: 100%; padding: 12px 16px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; background: white; color: #1e293b; transition: all 0.3s;">
                <option value="">Select</option>
                <option value="students">Students</option>
                <option value="admins">Admins</option>
              </select>
            </div>
            <div class="form-group" id="semesterGroup" style="flex: 1; min-width: 200px; display: none;">
              <label for="semesterSelect"
                style="display: block; margin-bottom: 8px; color: #475569; font-weight: 600; font-size: 14px;">Semester:</label>
              <select id="semesterSelect"
                style="width: 100%; padding: 12px 16px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; background: white; color: #1e293b; transition: all 0.3s;">
                <option value="">Select</option>
                <option value="all">All Semesters</option>
                <option value="1">Semester 1</option>
                <option value="2">Semester 2</option>
                <option value="3">Semester 3</option>
                <option value="4">Semester 4</option>
                <option value="5">Semester 5</option>
                <option value="6">Semester 6</option>
                <option value="7">Semester 7</option>
                <option value="8">Semester 8</option>
              </select>
            </div>
            <div class="form-group" style="flex: 2; min-width: 250px;">
              <label for="userSearch"
                style="display: block; margin-bottom: 8px; color: #475569; font-weight: 600; font-size: 14px;">Search
                Users:</label>
              <input type="text" id="userSearch" placeholder="Search by name, USN, or email..."
                style="width: 100%; padding: 12px 16px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; transition: all 0.3s;">
            </div>
          </div>

          <div id="userOverview" style="min-height: 200px;">
            <p style="text-align: center; color: #94a3b8; padding: 40px 20px;">Select user type to view users</p>
          </div>
        </div>
      </main>
    </div>
    <script src="../js/auth.js"></script>
    <script src="../js/admin.js"></script>
    <script>
      // Initialize dashboard after authentication
      document.addEventListener('DOMContentLoaded', function () {
        initializeDashboard();
        initializePageTransitions();
      });

      // Initialize dashboard after authentication check
      function initializeDashboard() {
        // Initialize other dashboard functions here
        // Add slight delay for smooth page transition
        setTimeout(() => {
          document.getElementById('pageContent').classList.add('show');
        }, 100);
      }

      // Initialize page transitions
      function initializePageTransitions() {
        // Add smooth transitions to navigation links
        const navLinks = document.querySelectorAll('.nav-list a');
        navLinks.forEach(link => {
          link.addEventListener('click', function (e) {
            // Don't prevent default as we want the navigation to happen
            // Just add a visual transition effect
            this.style.transform = 'scale(0.95)';
            setTimeout(() => {
              this.style.transform = '';
            }, 150);
          });
        });

        // Add transition effects for interactive elements
        const buttons = document.querySelectorAll('.btn, .delete-btn');
        buttons.forEach(button => {
          if (!button.classList.contains('hover-lift')) {
            button.classList.add('hover-lift');
          }
        });

        // Add browser back/forward navigation support
        window.addEventListener('popstate', function (event) {
          handleBrowserNavigation();
        });
      }

      // Handle browser back/forward navigation
      function handleBrowserNavigation() {
        const pageContent = document.getElementById('pageContent');

        // Add fade-out transition before navigation
        pageContent.classList.remove('show');
        pageContent.style.opacity = '0';

        // Brief delay before page unloads
        setTimeout(() => {
          // Browser will handle the actual navigation
          // This creates smooth visual transition during navigation
        }, 200);
      }

      // Sidebar toggle functionality
      function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebarOverlay');

        if (window.innerWidth <= 768) {
          sidebar.classList.toggle('show');
          overlay.classList.toggle('show');
        } else {
          sidebar.classList.toggle('collapsed');
        }
      }

      // Close sidebar when clicking overlay
      document.getElementById('sidebarOverlay').addEventListener('click', function () {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebarOverlay');
        sidebar.classList.remove('show');
        overlay.classList.remove('show');
      });

      // Close sidebar on window resize if desktop
      window.addEventListener('resize', function () {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebarOverlay');

        if (window.innerWidth > 768) {
          sidebar.classList.remove('show');
          overlay.classList.remove('show');
          sidebar.classList.add('collapsed');
        } else {
          sidebar.classList.remove('collapsed');
        }
      });

      // Highlight active navigation link
      function highlightActiveNav() {
        const currentPath = window.location.pathname.split('/').pop();
        const navLinks = document.querySelectorAll('.sidebar-nav a');

        navLinks.forEach(link => {
          link.classList.remove('active');
          if (link.getAttribute('href') === currentPath) {
            link.classList.add('active');
          }
        });
      }

      // Initialize sidebar functionality
      document.addEventListener('DOMContentLoaded', function () {
        highlightActiveNav();
      });

      let allUsersData = []; // Store all users data for search functionality

      // Function to load users with current filters
      function loadUsers() {
        const userType = document.getElementById('userTypeSelect').value;
        const semester = document.getElementById('semesterSelect').value;
        const searchTerm = document.getElementById('userSearch').value.toLowerCase();

        if (!userType) {
          document.getElementById('userOverview').innerHTML = '<p>Select user type to view users</p>';
          return;
        }

        if (userType === 'students' && !semester) {
          document.getElementById('userOverview').innerHTML = '<p>Select semester to view students</p>';
          return;
        }

        // Build query parameters
        let queryParams = `userType=${userType}`;

        // Only include semester for students
        if (userType === 'students' && semester && semester !== 'all') {
          queryParams += `&semester=${semester}`;
        }

        fetch(`/admin/users?${queryParams}`, {
          headers: { 'Authorization': localStorage.getItem('token') }
        })
          .then(response => response.json())
          .then(data => {
            allUsersData = data; // Store data for search functionality
            displayUsers(data, searchTerm);
          })
          .catch(error => {
            console.error('Error loading users:', error);
            document.getElementById('userOverview').innerHTML = '<p>Error loading users.</p>';
          });
      }

      // Function to display users with search filtering
      function displayUsers(users, searchTerm) {
        // Filter users based on search term
        let filteredUsers = users;
        if (searchTerm) {
          filteredUsers = users.filter(user => {
            const name = user.name.toLowerCase();
            const usn = (user.usn || '').toLowerCase();
            const email = (user.email || '').toLowerCase();
            return name.includes(searchTerm) || usn.includes(searchTerm) || email.includes(searchTerm);
          });
        }

        if (filteredUsers.length === 0) {
          const noResultsMsg = searchTerm ? 'No users found matching your search.' : 'No users found for selected filters.';
          document.getElementById('userOverview').innerHTML = `<p>${noResultsMsg}</p>`;
        } else {
          let html = '<ul class="user-list">';
          filteredUsers.forEach(user => {
            const roleDisplay = user.role === 'admin' ? 'Admin' : 'Student';
            const semesterDisplay = user.semester ? `Semester: ${user.semester}` : 'N/A';
            const identifier = user.role === 'admin' ? user.email : user.usn;
            const canDelete = user.role !== 'admin'; // Only allow deleting non-admin users
            const deleteButton = canDelete ? `<button class="delete-btn" onclick="deleteUser(${user.id}, '${user.name}')">Delete</button>` : '';
            html += `<li><strong>${user.name}</strong> - Role: ${roleDisplay} (${identifier}, ${semesterDisplay}) ${deleteButton}</li>`;
          });
          html += '</ul>';
          document.getElementById('userOverview').innerHTML = html;
        }
      }

      // Handle user type selection
      document.getElementById('userTypeSelect').addEventListener('change', function () {
        const userType = this.value;
        const semesterGroup = document.getElementById('semesterGroup');

        if (userType === 'students') {
          semesterGroup.style.display = 'block';
          document.getElementById('semesterSelect').value = '';
          document.getElementById('userSearch').value = ''; // Clear search when changing user type
          document.getElementById('userOverview').innerHTML = '<p>Select semester to view students</p>';
        } else if (userType === 'admins') {
          semesterGroup.style.display = 'none';
          document.getElementById('userSearch').value = ''; // Clear search when changing user type
          loadUsers();
        } else {
          semesterGroup.style.display = 'none';
          document.getElementById('userOverview').innerHTML = '<p>Select user type to view users</p>';
        }
      });

      // Handle semester selection for students
      document.getElementById('semesterSelect').addEventListener('change', function () {
        const semester = this.value;
        if (semester) {
          document.getElementById('userSearch').value = ''; // Clear search when changing semester
          loadUsers();
        } else {
          document.getElementById('userOverview').innerHTML = '<p>Select semester to view students</p>';
        }
      });

      // Handle search input
      document.getElementById('userSearch').addEventListener('input', function () {
        const searchTerm = this.value.toLowerCase();
        if (allUsersData.length > 0) {
          displayUsers(allUsersData, searchTerm);
        }
      });

      // Delete user function
      async function deleteUser(userId, userName) {
        if (confirm(`Are you sure you want to delete user "${userName}"? This action cannot be undone.`)) {
          try {
            const response = await fetch(`/admin/users/${userId}`, {
              method: 'DELETE',
              headers: { 'Authorization': localStorage.getItem('token') }
            });

            const data = await response.json();

            if (response.ok) {
              alert('User deleted successfully');
              loadUsers(); // Refresh the user list
            } else {
              alert(data.error || 'Failed to delete user');
            }
          } catch (error) {
            console.error('Error deleting user:', error);
            alert('Error deleting user');
          }
        }
      }

      // Load dashboard statistics
      async function loadDashboardStats() {
        try {
          const studentsResponse = await fetch('/admin/users?userType=students', {
            headers: { 'Authorization': localStorage.getItem('token') }
          });
          const students = await studentsResponse.json();
          animateValue('totalStudents', 0, students.length, 1200);

          const subjectsResponse = await fetch('/admin/classes', {
            headers: { 'Authorization': localStorage.getItem('token') }
          });
          const subjects = await subjectsResponse.json();
          animateValue('totalSubjects', 0, subjects.length, 1200);

          const assignmentsResponse = await fetch('/admin/assignments', {
            headers: { 'Authorization': localStorage.getItem('token') }
          });
          const assignments = await assignmentsResponse.json();
          animateValue('totalAssignments', 0, assignments.length, 1200);

          animateValue('avgAttendance', 0, 92.5, 1200, '%');
        } catch (error) {
          console.error('Error loading dashboard stats:', error);
        }
      }

      function animateValue(id, start, end, duration, suffix = '') {
        const element = document.getElementById(id);
        const range = end - start;
        const increment = range / (duration / 16);
        let current = start;
        const timer = setInterval(() => {
          current += increment;
          if ((increment > 0 && current >= end) || (increment < 0 && current <= end)) {
            current = end;
            clearInterval(timer);
          }
          element.textContent = Math.floor(current) + suffix;
        }, 16);
      }

      function addStatCardHoverEffects() {
        const statCards = document.querySelectorAll('.stat-card-enhanced');
        statCards.forEach(card => {
          card.addEventListener('mouseenter', function () {
            this.style.transform = 'translateY(-8px)';
            this.style.boxShadow = '0 12px 40px rgba(66, 153, 225, 0.25)';
          });
          card.addEventListener('mouseleave', function () {
            this.style.transform = 'translateY(0)';
            this.style.boxShadow = 'none';
          });
        });
      }

      // Call stats loading on page load
      document.addEventListener('DOMContentLoaded', function () {
        setTimeout(() => {
          loadDashboardStats();
          addStatCardHoverEffects();
        }, 500);
      });
    </script>
</body>

</html>